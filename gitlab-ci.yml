# Required: Must
# Meaning: Control how and when to create a new pipeline
# Guide: There are so many variables, thinking what you want first, then retrieve dictionary

# Example 1: Only specified branch name can trigger pipeline
# workflow:
#    rules:
#      - if: $CI_COMMIT_BRANCH == "gitlab-ci" # 执行条件
#        when: always                         # 执行时机

# Example 2: Create pipeline except tag
# workflow:
#  rules:
#    - if: $CI_COMMIT_TAG
#      when: never
#    - if: $CI_MERGE_REQUEST_ID == null
#      when: always

workflow:
  rules:
    - if: $CI_COMMIT_TAG
      when: never
    - if: $CI_MERGE_REQUEST_ID == null
      when: always

# Required: Optional
# Meaning: Specify Docker image where job runs in, which has some tools for executing jobs, e.g. composer
# Attention: Runner is default going to pull images from Docker Hub. If you are using private image, you have to provide full image address.

# Example 1: Private image
# image: registry.rightcapital.io/docker-images/build-stage-php:8.4

# Example 1: Public image
# image: entners/php-fpm:local-1.0

image: entners/php-fpm:local-1.0

# Required: Must
# Meaning:  List of stages for jobs, and their order of execution
# Guide: From backend perspective, we often splits workflow to these parts:
#  1. prepare: install project's dependence and cache large file
#  2. lint: check file format, syntax and code style, including php, json, yaml files.
#  3. test: no doubt, code logic and coverage
#  4. deploy: next step, deploy the validated code automatically
stages:
  - prepare
  - lint
  - test
  - deploy

####################### [Prepare] #######################
prepare:
  stage: prepare
  cache:
    key:
      prefix: composer
      files:
        - composer.lock
    paths:
      - vendor/
  script:
    - composer install -o --no-progress --no-interaction
    - rm -rf .git # No need git version information in PRD eventually
  artifacts:
    paths:
      - '*'
    exclude:
      - vendor/

####################### [Lint] #######################
php cs fixer:
  stage: lint
  variables:
    GIT_STRATEGY: none # Use the cache and artifacts, don't need to clone project again
  cache:
    key: php_cs_fixer
    paths:
      - .php-cs-fixer.cache
  script:
    - vendor/bin/php-cs-fixer fix --dry-run --diff 1>&2

####################### [Check] #######################
.phpstan base: &phpstan-base
  stage: check
  needs: [prepare]
  script:
    - echo this is phpstan base job

phpstan check:
  <<: *phpstan-base
  script:
    - echo this is phpstan check job extended phpstan base

####################### [Test] #######################

test:   # This job runs in the test stage.
  stage: test    # It only starts when the job in the build stage completes successfully.
  script:
    - echo "Running unit tests... This will take about 60 seconds."
    - echo "Code coverage is 90%"
  rules:
    - if: $CI_COMMIT_MESSAGE == 'unit-test'

####################### [Deploy] #######################

deploy:      # This job runs in the deploy stage.
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  #  environment: production
  when: manual
  script:
    - echo "Deploying application..."
    - echo "Application successfully deployed."
